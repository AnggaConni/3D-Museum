<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artifact Catalogue - Live Data</title>
    <!-- Three.js Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Orbit Controls -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- GSAP for Animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse for Parsing CSV Text -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; overflow: hidden; background-color: #020617; font-family: 'Rajdhani', sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* Glassmorphism UI */
        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(6, 182, 212, 0.3);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.1);
        }

        /* Tooltip Hover */
        #tooltip {
            position: absolute;
            background: rgba(2, 6, 23, 0.95);
            color: #22d3ee;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            border: 1px solid #22d3ee;
            display: none;
            z-index: 100;
            white-space: nowrap;
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.4);
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --- CYBERPUNK TITLE STYLES --- */
        .cyber-title {
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            color: #fff;
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #0ff, 0 0 40px #0ff;
            animation: flicker 2s infinite alternate;
        }

        @keyframes flicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { text-shadow: 0 0 5px #fff, 0 0 20px #0ff; }
            20%, 24%, 55% { text-shadow: none; }
        }

        .cyber-btn {
            background: transparent;
            border: 2px solid #0ff;
            color: #0ff;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            transition: 0.3s;
            box-shadow: 0 0 10px #0ff;
        }
        .cyber-btn:hover {
            background: #0ff;
            color: #000;
            box-shadow: 0 0 20px #0ff, 0 0 40px #0ff;
        }

        /* Decorative Pipes/Cables */
        .cable-decor {
            position: absolute;
            background: linear-gradient(90deg, #333, #111);
            border: 1px solid #444;
            z-index: -1;
        }
        .cable-h { height: 8px; width: 100vw; top: 20%; left: 0; border-bottom: 2px solid #0ff; opacity: 0.5; }
        .cable-v { width: 8px; height: 100vh; top: 0; right: 20%; border-right: 2px solid #f0f; opacity: 0.5; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #0891b2; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #22d3ee; }
    </style>
</head>
<body>

    <!-- TOOLTIP HOVER -->
    <div id="tooltip"></div>

    <!-- UI LAYER -->
    <div id="ui-layer" class="absolute inset-0 pointer-events-none flex flex-col justify-between p-6 z-10">
        
        <!-- Header -->
        <div class="flex justify-between items-start pointer-events-auto w-full">
            <div class="glass-panel p-4 rounded-lg animate-fade-in-down border-l-4 border-cyan-400">
                <h1 class="text-white text-2xl font-bold tracking-wider font-[Orbitron]">ARTIFACT <span class="text-cyan-400">DB</span></h1>
                <p class="text-gray-400 text-sm mt-1 uppercase tracking-widest">Live Sync // Google Sheets</p>
                <div class="mt-2 flex items-center gap-2">
                    <div id="connection-status" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse shadow-[0_0_10px_#eab308]"></div>
                    <span id="connection-text" class="text-xs text-yellow-300 font-mono">Initializing...</span>
                </div>
            </div>

            <!-- Right Controls -->
            <div class="flex flex-col items-end gap-2">
                <button onclick="openInfoModal()" class="glass-panel w-10 h-10 rounded-full flex items-center justify-center text-cyan-400 hover:bg-cyan-900/50 hover:text-white transition mb-2 shadow-[0_0_15px_rgba(6,182,212,0.3)] border border-cyan-500/50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>

                <!-- Data Stream Status -->
                <div class="glass-panel p-4 rounded-lg pointer-events-auto border-r-4 border-purple-500 min-w-[200px]">
                    <p class="text-xs text-purple-400 mb-1 font-bold uppercase tracking-widest">Data Stream</p>
                    <div id="data-display" class="font-mono text-xs text-gray-300">
                        <span class="text-yellow-400 animate-spin inline-block">◌</span> Connecting...
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div id="nav-controls" class="pointer-events-auto opacity-0 transition-opacity duration-500">
            <button onclick="goBackToMap()" class="glass-panel px-6 py-3 rounded-none skew-x-[-10deg] text-cyan-400 border border-cyan-500 hover:bg-cyan-900/30 flex items-center gap-2 transition group">
                <span class="skew-x-[10deg] flex items-center gap-2 font-[Orbitron] text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    RETURN TO SECTOR MAP
                </span>
            </button>
            <div class="mt-4 flex gap-4">
                 <div id="room-indicator" class="text-white text-sm font-[Orbitron] glass-panel inline-block px-3 py-1 border-l-2 border-cyan-500">
                    SECTOR 1
                </div>
            </div>
        </div>
    </div>

    <!-- TITLE SCREEN -->
    <div id="title-screen" class="absolute inset-0 z-50 bg-[#020617] flex flex-col items-center justify-center transition-opacity duration-1000 overflow-hidden">
        <div class="absolute inset-0 opacity-20" style="background-image: linear-gradient(#0ff 1px, transparent 1px), linear-gradient(90deg, #0ff 1px, transparent 1px); background-size: 50px 50px; perspective: 1000px; transform: rotateX(60deg) scale(2);"></div>
        <div class="cable-decor cable-h"></div>
        <div class="cable-decor cable-v"></div>
        
        <div class="text-center z-10 p-10 border border-cyan-500/30 bg-black/80 backdrop-blur-sm relative">
            <div class="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-cyan-400"></div>
            <div class="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-cyan-400"></div>

            <h1 class="text-6xl md:text-8xl font-bold mb-2 cyber-title tracking-tighter">NEO<br>MUSEUM</h1>
            <p class="text-cyan-400 text-xl mb-8 font-[Rajdhani] tracking-[0.5em] uppercase">Nyah Lasem Heritage</p>
            
            <button onclick="startGame()" id="start-btn" class="cyber-btn px-10 py-4 font-bold text-lg rounded-sm group disabled:opacity-50 disabled:cursor-not-allowed">
                CONNECTING...
            </button>
            <p id="boot-status" class="text-xs text-gray-500 mt-2 font-mono">Attempting Satellite Link...</p>
        </div>
        <p class="absolute bottom-10 text-slate-600 text-sm font-mono border-t border-slate-800 pt-2">
            SYSTEM ARCHITECT: ANGGA CONNI SAPUTRA // BUILD 2026
        </p>
    </div>

    <!-- ARTIFACT MODAL -->
    <div id="artifact-modal" class="absolute inset-0 z-40 bg-black/80 backdrop-blur-md hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="glass-panel w-full max-w-4xl h-[80vh] rounded-none border border-cyan-500/50 overflow-hidden flex flex-col md:flex-row shadow-[0_0_50px_rgba(6,182,212,0.2)] transform scale-95 transition-transform duration-300" id="modal-content">
            <div class="w-full md:w-1/2 bg-slate-900 relative group overflow-hidden flex items-center justify-center border-r border-cyan-500/30">
                <img id="modal-img" src="" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 absolute inset-0 opacity-80 hover:opacity-100" alt="Artifact">
                
                <!-- NEW: PROFESSIONAL FALLBACK BOX (Displays when image fails) -->
                <div id="modal-img-fallback" class="hidden absolute inset-0 bg-slate-900 flex flex-col items-center justify-center p-8 text-center">
                    <div class="w-full h-full border-2 border-dashed border-cyan-500/30 flex flex-col items-center justify-center p-6 relative">
                        <div class="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-cyan-500"></div>
                        <div class="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-cyan-500"></div>
                        
                        <p class="text-cyan-500 font-mono text-xs mb-2 uppercase tracking-widest">Visual Data Corrupted</p>
                        <h3 id="fallback-title" class="text-2xl md:text-3xl text-white font-[Orbitron] font-bold uppercase break-words leading-tight">ARTIFACT NAME</h3>
                        <div class="mt-4 w-12 h-1 bg-cyan-500/50"></div>
                        <p class="mt-2 text-slate-500 text-xs font-mono">ID_REF: <span id="fallback-id">---</span></p>
                    </div>
                </div>

                <div class="absolute bottom-4 left-4 text-white z-10">
                    <p class="text-xs font-mono text-cyan-400 mb-1 bg-black/50 inline-block px-2">ID: #<span id="modal-id">001</span></p>
                </div>
            </div>
            <div class="w-full md:w-1/2 p-8 flex flex-col relative bg-black/40">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-cyan-600 hover:text-cyan-300 pointer-events-auto z-20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
                <h2 id="modal-title" class="text-3xl font-bold text-white mb-2 mt-4 font-[Orbitron] uppercase text-transparent bg-clip-text bg-gradient-to-r from-white to-cyan-400">Artifact Name</h2>
                <div class="flex gap-2 mb-6">
                    <span id="modal-category" class="px-2 py-1 bg-cyan-900/30 text-cyan-300 text-xs border border-cyan-700 uppercase font-bold tracking-wider">Category</span>
                    <span id="modal-date" class="px-2 py-1 bg-purple-900/30 text-purple-300 text-xs border border-purple-700 font-mono">Year ----</span>
                </div>
                <div class="flex-grow overflow-y-auto pr-2 text-slate-300 leading-relaxed text-sm font-[Rajdhani] text-lg">
                    <p id="modal-desc">Description goes here...</p>
                    <p class="mt-4 text-xs text-gray-500 font-mono border-t border-gray-800 pt-2" id="modal-meta">METADATA SOURCE: LOADING...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- INFO / TUTORIAL MODAL -->
    <div id="info-modal" class="absolute inset-0 z-[60] bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="glass-panel w-full max-w-3xl max-h-[90vh] rounded-lg overflow-hidden flex flex-col shadow-2xl relative border border-cyan-500/30">
            <button onclick="closeInfoModal()" class="absolute top-6 right-6 text-gray-400 hover:text-white bg-slate-800 rounded-full p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div class="p-8 overflow-y-auto custom-scrollbar">
                <h2 class="text-3xl font-bold text-white mb-1 font-[Orbitron]">SYSTEM MANUAL</h2>
                <p class="text-cyan-400 mb-6 text-sm uppercase tracking-widest">Live Data Integration</p>
                <div class="space-y-6 text-slate-300 text-sm font-mono">
                    <div class="bg-slate-900/80 p-4 border-l-4 border-green-500">
                        <h3 class="text-white font-bold text-lg mb-2 flex items-center gap-2"><span class="text-green-400">[CONNECTED]</span> Google Sheets Linkage</h3>
                        <p class="mb-2">Data is pulled live from your published CSV.</p>
                        <p class="text-xs text-gray-500">Source: ...WwxlLqEupcIWxJ/pub?output=csv</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CANVAS -->
    <div id="canvas-container"></div>

    <script>
        // --- CONFIGURATION ---
        const config = {
            itemsPerRoom: 20,
            wallColor: 0x1e293b,
            floorColor: 0x0f172a,
            accentColor: 0x06b6d4,
            sheetUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQwKmyadrIerG4AoqamYKVD39UpeA0s0poj0c1bAmGDoR9XfRPEq0SfjEByFZHTx51ywlLqEupcIWxJ/pub?output=csv'
        };

        let state = {
            scene: 'TITLE', 
            currentCategory: null,
            totalItems: 0, 
            currentRoomIndex: 0,
            allData: [], 
            filteredData: [],
            isOffline: false
        };

        let scene, camera, renderer, raycaster, mouse;
        let controls;
        let objectsToIntersect = []; 
        let roomObjects = []; 
        let activeFishes = []; 
        let dirLight, ambientLight;
        let audioCtx; 

        // --- AUDIO SYSTEM ---
        function initAudio() {
            if (!audioCtx) {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioCtx = new AudioContext();
                } catch(e) { console.warn("Web Audio API not supported", e); }
            }
            if (audioCtx && audioCtx.state === 'suspended') { audioCtx.resume(); }
        }

        function playClickSound(freq = 800) {
            initAudio(); if (!audioCtx) return;
            try {
                const oscillator = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode); gainNode.connect(audioCtx.destination);
                oscillator.type = 'sawtooth'; oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime); oscillator.frequency.exponentialRampToValueAtTime(freq/4, audioCtx.currentTime + 0.15);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.15);
            } catch (e) { console.warn("Audio play error", e); }
        }
        function playSplashSound() { playClickSound(400); setTimeout(() => playClickSound(600), 100); }

        // --- DATA SYSTEM (FAIL-SAFE MODE) ---
        function generateEmergencyData() {
            console.warn(">> GENERATING EMERGENCY DATA (OFFLINE MODE) <<");
            const dummy = [];
            const cats = ['underwater', 'ancient_craft', 'museum'];
            // Create fake items for offline mode
            cats.forEach(cat => {
                for(let i=1; i<=25; i++) {
                    dummy.push({
                        id: `OFFLINE-${i}`,
                        title: `${cat.toUpperCase().replace('_',' ')} SAMPLE ${i}`,
                        desc: "Connection to Google Sheets failed. This is offline sample data. Check CORS/Network.",
                        image_url: "", // Force fallback box
                        category: cat,
                        year: "2026"
                    });
                }
            });
            return dummy;
        }

        async function loadGoogleSheetData() {
            const updateUI = (data, source) => {
                console.log(`[DATA LOADED] Source: ${source}, Count: ${data.length}`);
                state.allData = data;
                state.isOffline = (source.includes('OFFLINE'));
                
                const btn = document.getElementById('start-btn');
                if(btn) {
                    btn.innerText = "ENTER SYSTEM";
                    btn.disabled = false;
                    btn.classList.add("animate-pulse");
                }
                
                const connStatus = document.getElementById('connection-status');
                const connText = document.getElementById('connection-text');
                const dataDisplay = document.getElementById('data-display');
                const bootStatus = document.getElementById('boot-status');
                
                if (state.isOffline) {
                    if(connStatus) { connStatus.classList.replace('bg-yellow-500', 'bg-orange-500'); }
                    if(connText) { connText.innerText = "OFFLINE MODE"; connText.classList.replace('text-yellow-300', 'text-orange-300'); }
                    if(dataDisplay) { dataDisplay.innerHTML = `<span class="text-orange-400">⚠</span> Demo Data Loaded`; }
                    if(bootStatus) { bootStatus.innerText = "Network Error. Loaded Offline Backup."; }
                } else {
                    if(connStatus) { connStatus.classList.replace('bg-yellow-500', 'bg-green-500'); connStatus.classList.replace('shadow-[0_0_10px_#eab308]', 'shadow-[0_0_10px_#22c55e]'); }
                    if(connText) { connText.innerText = "LIVE DATA SYNCED"; connText.classList.replace('text-yellow-300', 'text-green-300'); }
                    if(dataDisplay) { dataDisplay.innerHTML = `<span class="text-green-400">●</span> ${state.allData.length} Artifacts Loaded`; }
                    if(bootStatus) { bootStatus.innerText = "Satellite Link Established."; }
                }
            };

            // STRATEGY: 1. Try Direct Fetch -> 2. Try Proxy -> 3. Load Offline
            try {
                // 1. DIRECT FETCH
                document.getElementById('boot-status').innerText = "Dialing Google Server...";
                // Add Timestamp to bust cache
                const url = config.sheetUrl + '&t=' + Date.now();
                
                const response = await fetch(url);
                if (response.ok) {
                    const csvText = await response.text();
                    parseCSV(csvText, "LIVE SHEET");
                    return;
                }
            } catch (e) {
                console.warn("Direct fetch failed, trying proxy...");
            }

            try {
                // 2. PROXY FETCH (Backup)
                document.getElementById('boot-status').innerText = "Direct failed. Routing via Proxy...";
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(config.sheetUrl)}`;
                const response = await fetch(proxyUrl);
                if (response.ok) {
                    const csvText = await response.text();
                    parseCSV(csvText, "PROXY SHEET");
                    return;
                }
            } catch (e) {
                console.warn("Proxy failed, loading offline...");
            }

            // 3. OFFLINE FALLBACK
            updateUI(generateEmergencyData(), "OFFLINE DEMO");

            // Internal Parse Helper
            function parseCSV(csvText, sourceName) {
                // Basic validation
                if(!csvText || csvText.trim().startsWith('<')) {
                    updateUI(generateEmergencyData(), "OFFLINE (Invalid CSV)");
                    return;
                }

                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            updateUI(results.data, sourceName);
                        } else {
                            updateUI(generateEmergencyData(), "OFFLINE DEMO (Empty)");
                        }
                    },
                    error: function() {
                         updateUI(generateEmergencyData(), "OFFLINE DEMO (Parse Error)");
                    }
                });
            }
        }

        // --- HELPER: CONVERT DRIVE LINK TO DIRECT IMAGE (IMPROVED) ---
        function getDirectDriveUrl(url) {
            if (!url) return "";
            
            // Pattern 1: Standard /file/d/
            const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (match) return `https://lh3.googleusercontent.com/d/${match[1]}`;
            
            // Pattern 2: id= parameter
            const matchId = url.match(/id=([a-zA-Z0-9_-]+)/);
            if (matchId) return `https://lh3.googleusercontent.com/d/${matchId[1]}`;
            
            return url; 
        }

        // --- SMART COLUMN FILTER ---
        function getColumnValue(item, possibleKeys) {
            if(!item) return null;
            const keys = Object.keys(item);
            for (let key of keys) {
                if (possibleKeys.includes(key.toLowerCase().trim())) return item[key];
            }
            return null;
        }

        function filterDataByCategory(category) {
            return state.allData.filter(item => {
                const cat = getColumnValue(item, ['category', 'kategori', 'cat']);
                return cat && cat.toLowerCase().trim() === category.toLowerCase().trim();
            }).map(item => ({
                id: getColumnValue(item, ['id', 'no']) || 'N/A',
                title: getColumnValue(item, ['title', 'nama', 'name', 'judul']) || 'Unknown Artifact',
                description: getColumnValue(item, ['desc', 'description', 'deskripsi']) || 'No description available.',
                imageUrl: getDirectDriveUrl(getColumnValue(item, ['image_url', 'img', 'image', 'gambar']) || ''),
                year: getColumnValue(item, ['year', 'tahun']) || 'Unknown',
                color: getCategoryColor(category),
                category: category
            }));
        }

        function getCategoryColor(cat) {
            if(cat === 'underwater') return 0x3b82f6; 
            if(cat === 'ancient_craft') return 0xf97316; 
            if(cat === 'museum') return 0xa8a29e;
            return 0xffffff;
        }

        // --- INIT ---
        function init() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020617);
            scene.fog = new THREE.FogExp2(0x020617, 0.02);

            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 1000);
            camera.position.set(0, 20, 40);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enabled = false;

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            setupLights();
            loadGoogleSheetData(); 

            window.addEventListener('resize', onWindowResize);
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('click', onMouseClick);
            animate();
        }

        function setupLights() {
            ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(ambientLight);
            dirLight = new THREE.DirectionalLight(0xa5f3fc, 0.5);
            dirLight.position.set(20, 30, 20);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight);
        }

        // --- TEXTURES & HELPERS ---
        function createTileTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = '#1e293b'; ctx.fillRect(0, 0, 512, 512);
            ctx.strokeStyle = '#334155'; ctx.lineWidth = 4;
            for(let x=0; x<=512; x+=64) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, 512); ctx.stroke(); }
            for(let y=0; y<=512; y+=64) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(512, y); ctx.stroke(); }
            const t = new THREE.CanvasTexture(canvas); t.wrapS = t.wrapT = THREE.RepeatWrapping; t.repeat.set(4, 4); return t;
        }
        function createGrungeWallTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = '#e2e8f0'; ctx.fillRect(0, 0, 512, 512);
            for(let i=0; i<150; i++) {
                const x = Math.random()*512; const y = Math.random()*512; const r = 5+Math.random()*20;
                const g = ctx.createRadialGradient(x,y,0,x,y,r); g.addColorStop(0,"rgba(139,69,19,0.4)"); g.addColorStop(1,"rgba(139,69,19,0)");
                ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,2*Math.PI); ctx.fill();
            }
            ctx.fillStyle = "rgba(0,0,0,0.05)"; for(let i=0; i<5000; i++) ctx.fillRect(Math.random()*512, Math.random()*512, 2, 2);
            const t = new THREE.CanvasTexture(canvas); t.wrapS = t.wrapT = THREE.RepeatWrapping; t.repeat.set(2, 1); return t;
        }
        function createPavementTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = '#334155'; ctx.fillRect(0,0,512,512);
            ctx.fillStyle = '#475569'; for(let i=0; i<3000; i++) ctx.fillRect(Math.random()*512,Math.random()*512,2,2);
            ctx.strokeStyle = '#1e293b'; ctx.lineWidth=2;
            for(let i=0;i<=512;i+=64){ctx.beginPath();ctx.moveTo(i,0);ctx.lineTo(i,512);ctx.stroke();ctx.beginPath();ctx.moveTo(0,i);ctx.lineTo(512,i);ctx.stroke();}
            const t = new THREE.CanvasTexture(canvas); t.wrapS = t.wrapT = THREE.RepeatWrapping; t.repeat.set(50,50); return t;
        }
        function createWindowTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = '#020617'; ctx.fillRect(0,0,64,64);
            const colors = ['#06b6d4', '#d946ef', '#ffffff'];
            // BRIGHTER WINDOWS: Increased chance and number
            if(Math.random()>0.3){ ctx.fillStyle=colors[Math.floor(Math.random()*colors.length)];
            if(Math.random()>0.2)ctx.fillRect(10,10,15,20); if(Math.random()>0.2)ctx.fillRect(35,10,15,20);
            if(Math.random()>0.2)ctx.fillRect(10,35,15,20); if(Math.random()>0.2)ctx.fillRect(35,35,15,20); }
            const t = new THREE.CanvasTexture(canvas); t.magFilter = THREE.NearestFilter; return t;
        }
        function addBreathingAnimation(obj) {
            obj.traverse((child) => {
                if (child.isMesh && child.material && child.material.isMeshStandardMaterial) {
                    if (child.material.emissive.r === 0 && child.material.emissive.g === 0 && child.material.emissive.b === 0) {
                        child.material.emissive.copy(child.material.color).multiplyScalar(0.2);
                        if(child.material.color.getHex() === 0) child.material.emissive.setHex(0x22d3ee);
                    }
                    gsap.to(child.material, { emissiveIntensity: 0.4, duration: 1.5, yoyo: true, repeat: -1, ease: "sine.inOut" });
                }
            });
        }

        // --- MAP SCENE ---
        function createMapScene() {
            clearScene(); state.scene = 'MAP';
            
            const displayEl = document.getElementById('data-display');
            if(displayEl) displayEl.innerText = `${state.allData.length} Artifacts Ready`;
            
            gsap.to(scene.background, { r: 0.01, g: 0.02, b: 0.05, duration: 1 }); 
            scene.fog = new THREE.FogExp2(0x020617, 0.01); 
            dirLight.intensity = 0.8; ambientLight.intensity = 0.5;
            controls.enabled = true; controls.enableZoom = false; controls.enablePan = false;
            controls.maxPolarAngle = Math.PI / 2.2; controls.minPolarAngle = Math.PI / 4;
            gsap.to(camera.position, { x: 0, y: 15, z: 40, duration: 1.5, ease: "power2.inOut" });

            const groundGeo = new THREE.PlaneGeometry(300, 300);
            const pavingTex = createPavementTexture();
            const groundMat = new THREE.MeshStandardMaterial({ map: pavingTex, roughness: 0.8, color: 0x888888 });
            const ground = new THREE.Mesh(groundGeo, groundMat); ground.rotation.x = -Math.PI / 2; ground.receiveShadow = true;
            scene.add(ground);

            const buildMat = new THREE.MeshStandardMaterial({ color: 0x1e293b });
            // UPGRADED TEXTURE CALL
            const windowTex = createWindowTexture();
            const winMat = new THREE.MeshBasicMaterial({ map: windowTex });
            
            for(let i=0; i<300; i++) { 
                const angle = Math.random() * Math.PI * 2; const radius = 60 + Math.random() * 60; 
                const bx = Math.cos(angle) * radius; const bz = Math.sin(angle) * radius;
                const height = 4 + Math.random() * 12; const width = 1.5 + Math.random() * 2.5; 
                const buildGeo = new THREE.BoxGeometry(width, height, width);
                const building = new THREE.Mesh(buildGeo, [winMat, winMat, buildMat, buildMat, winMat, winMat]);
                building.position.set(bx, height/2, bz); building.lookAt(0, height/2, 0); scene.add(building);
            }

            // Ship Model
            const shipGroup = new THREE.Group(); shipGroup.position.set(-14, 0, 0);
            const waterGeo = new THREE.CylinderGeometry(5, 5, 0.2, 32);
            const waterMat = new THREE.MeshStandardMaterial({ color: 0x3b82f6, transparent: true, opacity: 0.7, roughness: 0.2, emissive: 0x0044aa, emissiveIntensity: 0.2 });
            const waterBase = new THREE.Mesh(waterGeo, waterMat); waterBase.position.y = 0.1; shipGroup.add(waterBase);
            const hullGeo = new THREE.SphereGeometry(2.5, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2); 
            const hullMat = new THREE.MeshStandardMaterial({ color: 0x855E42, roughness: 0.8 }); 
            const hull = new THREE.Mesh(hullGeo, hullMat); hull.scale.set(1, 0.8, 2.5); hull.rotation.x = Math.PI; hull.position.y = 2.2; shipGroup.add(hull);
            const deckGeo = new THREE.CircleGeometry(2.4, 32); const deckMat = new THREE.MeshStandardMaterial({ color: 0x5c4033 });
            const deck = new THREE.Mesh(deckGeo, deckMat); deck.rotation.x = -Math.PI / 2; deck.position.y = 2.2; deck.scale.set(1, 2.5, 1); shipGroup.add(deck);
            const mastGeo = new THREE.CylinderGeometry(0.1, 0.1, 5); const mast = new THREE.Mesh(mastGeo, deckMat); mast.position.set(0, 4.5, 0); shipGroup.add(mast);
            const sailGeo = new THREE.ConeGeometry(1.5, 3, 3); sailGeo.scale(1, 1, 0.1);
            const sailMat = new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xaaaaaa, emissiveIntensity: 0.2 });
            const sail = new THREE.Mesh(sailGeo, sailMat); sail.position.set(0.8, 5, 0); sail.rotation.z = -Math.PI / 8; shipGroup.add(sail);
            
            // FIXED: Correct Category Name from Sheet
            shipGroup.userData = { type: 'category', value: 'underwater', name: 'Underwater Heritage', desc: 'Ancient Shipwrecks' };
            scene.add(shipGroup); objectsToIntersect.push(shipGroup); addFloatingAnimation(shipGroup, 0); addBreathingAnimation(shipGroup);

            // Wae Rebo Model
            const houseGroup = new THREE.Group(); houseGroup.position.set(0, 0, 0);
            const stoneBaseGeo = new THREE.CylinderGeometry(3.5, 4, 0.5, 16);
            const stoneMat = new THREE.MeshStandardMaterial({ color: 0x57534e, roughness: 0.9 });
            const stoneBase = new THREE.Mesh(stoneBaseGeo, stoneMat); stoneBase.position.y = 0.25; houseGroup.add(stoneBase);
            const roofGeo = new THREE.ConeGeometry(3.2, 7, 16, 4, true); 
            const thatchMat = new THREE.MeshStandardMaterial({ color: 0x5D4037, roughness: 1.0 }); 
            const roof = new THREE.Mesh(roofGeo, thatchMat); roof.position.y = 4; houseGroup.add(roof);
            const finialGeo = new THREE.CylinderGeometry(0.1, 0.3, 1, 8);
            const woodFinialMat = new THREE.MeshStandardMaterial({ color: 0x271c19 });
            const finial = new THREE.Mesh(finialGeo, woodFinialMat); finial.position.y = 7.5; houseGroup.add(finial);
            const doorGeo = new THREE.BoxGeometry(1, 1.5, 0.5);
            const doorMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
            const door = new THREE.Mesh(doorGeo, doorMat); door.position.set(0, 1.25, 2.8); door.rotation.x = -0.2; houseGroup.add(door);
            
            // FIXED: Correct Category Name from Sheet
            houseGroup.userData = { type: 'category', value: 'ancient_craft', name: 'Ancient Craft Gallery', desc: 'Sumbawa Heritage - ICH' };
            scene.add(houseGroup); objectsToIntersect.push(houseGroup); addFloatingAnimation(houseGroup, 1); addBreathingAnimation(houseGroup);

            // Museum Model
            const museumGroup = new THREE.Group(); museumGroup.position.set(14, 0, 0);
            const padGeo = new THREE.CylinderGeometry(5, 5, 0.2, 32);
            const padMat = new THREE.MeshStandardMaterial({ color: 0x555555, roughness: 0.8 }); 
            const padBase = new THREE.Mesh(padGeo, padMat); padBase.position.y = 0.1; museumGroup.add(padBase);
            const mBodyGeo = new THREE.BoxGeometry(5, 3, 4);
            const concreteMat = new THREE.MeshStandardMaterial({ color: 0xe2e8f0, emissive: 0x333333, emissiveIntensity: 0.2 });
            const mBody = new THREE.Mesh(mBodyGeo, concreteMat); mBody.position.y = 1.75; museumGroup.add(mBody);
            const pillarGeo = new THREE.CylinderGeometry(0.3, 0.3, 3);
            for(let i=-1.5; i<=1.5; i+=1) { const pillar = new THREE.Mesh(pillarGeo, concreteMat); pillar.position.set(i, 1.75, 2.2); museumGroup.add(pillar); }
            const pedimentGeo = new THREE.CylinderGeometry(0, 3.5, 5, 3);
            const pediment = new THREE.Mesh(pedimentGeo, concreteMat); pediment.rotation.z = Math.PI / 2; pediment.rotation.x = Math.PI / 2; 
            pediment.scale.set(1, 0.5, 1); pediment.position.set(0, 4.2, 0); museumGroup.add(pediment);
            
            // FIXED: Correct Category Name from Sheet
            museumGroup.userData = { type: 'category', value: 'museum', name: 'General Museum', desc: 'Artifacts Gallery' };
            scene.add(museumGroup); objectsToIntersect.push(museumGroup); addFloatingAnimation(museumGroup, 2); addBreathingAnimation(museumGroup);
        }

        // --- ROOM SCENE ---
        function createRoomScene(category, roomIndex) {
            clearScene(); state.scene = 'ROOM'; state.currentRoomIndex = roomIndex;
            let floorColor = config.floorColor; let wallColor = config.wallColor;
            let lightIntensity = 0.8; let ambIntensity = 0.3;
            let isWaterFloor = false; let isRockWall = false; let isBambooWall = false; let isSoilFloor = false; let isTileFloor = false; let isIndustrialMuseum = false;
            
            if (category === 'underwater') { // FIXED: Key
                gsap.to(scene.background, { r: 0.0, g: 0.12, b: 0.25, duration: 1.5 });
                scene.fog = new THREE.FogExp2(0x001e40, 0.025);
                floorColor = 0x004d7a; isWaterFloor = true; isRockWall = true;
                lightIntensity = 1.2; ambIntensity = 0.6; dirLight.color.setHex(0x00ffff);
                createFishSchool(15); 
            } else if (category === 'ancient_craft') { // FIXED: Key
                gsap.to(scene.background, { r: 0.2, g: 0.15, b: 0.1, duration: 1.5 }); 
                scene.fog = new THREE.FogExp2(0x2d1b1e, 0.02);
                floorColor = 0x5d4037; isSoilFloor = true; wallColor = 0x3f2e27; isBambooWall = true; 
                lightIntensity = 1.2; ambIntensity = 0.6; dirLight.color.setHex(0xffffff);
            } else if (category === 'museum') {
                gsap.to(scene.background, { r: 0.1, g: 0.1, b: 0.12, duration: 1.5 }); 
                scene.fog = new THREE.FogExp2(0x111111, 0.015); 
                floorColor = 0x3e2723; wallColor = 0xeeeeee; 
                lightIntensity = 0.6; ambIntensity = 0.5; isIndustrialMuseum = true; dirLight.color.setHex(0xffe0b2);
            }

            dirLight.intensity = lightIntensity; ambientLight.intensity = ambIntensity;
            controls.enabled = true; controls.enableZoom = true; controls.enablePan = true;
            gsap.to(camera.position, { x: 20, y: 20, z: 20, duration: 1.5, onComplete: () => controls.target.set(0,0,0) });

            const startIdx = roomIndex * config.itemsPerRoom;
            const endIdx = startIdx + config.itemsPerRoom;
            const roomData = state.filteredData.slice(startIdx, endIdx);
            
            const floorGeo = new THREE.PlaneGeometry(30, 30);
            let floorMat;
            if (isWaterFloor) floorMat = new THREE.MeshStandardMaterial({ color: 0xc2b280, roughness: 1.0 }); 
            else if (isIndustrialMuseum) floorMat = new THREE.MeshStandardMaterial({ color: floorColor, roughness: 0.7, metalness: 0.1 });
            else if (isTileFloor) floorMat = new THREE.MeshStandardMaterial({ map: createTileTexture(), roughness: 0.2, metalness: 0.1 });
            else floorMat = new THREE.MeshStandardMaterial({ color: floorColor, roughness: 0.8 });
            
            const floor = new THREE.Mesh(floorGeo, floorMat); floor.rotation.x = -Math.PI / 2; floor.receiveShadow = true;
            scene.add(floor); roomObjects.push(floor);

            if (isSoilFloor) {
                const stoneCount = 15; const stoneGeo = new THREE.DodecahedronGeometry(0.4, 0); const stoneMat = new THREE.MeshStandardMaterial({ color: 0x8d6e63, roughness: 1.0 });
                for(let i=0; i<stoneCount; i++) {
                    const stone = new THREE.Mesh(stoneGeo, stoneMat);
                    const sx = (Math.random() - 0.5) * 25; const sz = (Math.random() - 0.5) * 25; const sScale = 0.5 + Math.random();
                    stone.position.set(sx, 0.2 * sScale, sz); stone.scale.set(sScale, sScale * 0.6, sScale); stone.rotation.set(Math.random(), Math.random(), Math.random());
                    scene.add(stone); roomObjects.push(stone);
                }
            }
            if (isWaterFloor) {
                const floodGeo = new THREE.BoxGeometry(30, 15, 30);
                const floodMat = new THREE.MeshStandardMaterial({ color: 0x00a8ff, roughness: 0.0, metalness: 0.1, transparent: true, opacity: 0.2, });
                const flood = new THREE.Mesh(floodGeo, floodMat); flood.position.y = 7.5; scene.add(flood); roomObjects.push(flood);
            }

            if (isRockWall) {
                const cliff1 = createRockWall(30, 12, 4, 0, new THREE.Vector3(0, 5, -15)); scene.add(cliff1); roomObjects.push(cliff1);
                const cliff2 = createRockWall(30, 12, 4, Math.PI/2, new THREE.Vector3(-15, 5, 0)); scene.add(cliff2); roomObjects.push(cliff2);
            } else if (isBambooWall) {
                const bambooGroup1 = createBambooWall(30, 0, -15, 0); scene.add(bambooGroup1); roomObjects.push(bambooGroup1);
                const bambooGroup2 = createBambooWall(30, -15, 0, Math.PI/2); scene.add(bambooGroup2); roomObjects.push(bambooGroup2);
            } else {
                const wallMat = new THREE.MeshStandardMaterial({ color: wallColor, side: THREE.DoubleSide });
                if(isIndustrialMuseum) { wallMat.map = createGrungeWallTexture(); wallMat.color.setHex(0xffffff); wallMat.roughness = 1.0; } 
                const wall1 = new THREE.Mesh(new THREE.BoxGeometry(30, 10, 1), wallMat); wall1.position.set(0, 5, -15); scene.add(wall1);
                const wall2 = new THREE.Mesh(new THREE.BoxGeometry(1, 10, 30), wallMat); wall2.position.set(-15, 5, 0); scene.add(wall2);
            }

            if (isIndustrialMuseum) {
                createHangingBeamLight(0, 8, 0); createIndustrialSconce(0, 6, -14.5, 0); createIndustrialSconce(-8, 6, -14.5, 0); createIndustrialSconce(8, 6, -14.5, 0); createIndustrialSconce(-14.5, 6, 0, Math.PI/2); createIndustrialSconce(-14.5, 6, -8, Math.PI/2); createIndustrialSconce(-14.5, 6, 8, Math.PI/2);
                const spotLight = new THREE.SpotLight(0xffffff, 0.5); spotLight.position.set(0, 15, 0); spotLight.angle = Math.PI / 4; spotLight.penumbra = 0.5; spotLight.castShadow = true; scene.add(spotLight);
            }

            let xOffset = -10; let zOffset = -10; const gap = 5;
            roomData.forEach((item, index) => {
                const col = index % 5; const row = Math.floor(index / 5);
                createArtifactPedestal(xOffset + (col * gap), 0, zOffset + (row * gap), item);
            });

            const totalRooms = Math.ceil(state.filteredData.length / config.itemsPerRoom);
            document.getElementById('nav-controls').style.opacity = '1';
            document.getElementById('room-indicator').innerText = `SECTOR ${roomIndex + 1} / ${totalRooms} (${category.toUpperCase().replace('_', ' ')})`;
            
            if (roomIndex < totalRooms - 1) createNavigationPoint(12, 0, 12, 'next', roomIndex + 1);
            if (roomIndex > 0) createNavigationPoint(-12, 0, -12, 'prev', roomIndex - 1);
        }

        // --- SCENE HELPERS ---
        function createRockWall(width, height, depth, rotationY, position) {
            const group = new THREE.Group(); group.position.copy(position); group.rotation.y = rotationY;
            const baseGeo = new THREE.BoxGeometry(width, height, 1); const baseMat = new THREE.MeshBasicMaterial({ color: 0x0f172a }); const base = new THREE.Mesh(baseGeo, baseMat); group.add(base);
            const rockGeo = new THREE.DodecahedronGeometry(1, 0); const rockMat = new THREE.MeshStandardMaterial({ color: 0x334155, roughness: 0.9, flatShading: true });
            const count = Math.floor((width * height) / 3); 
            for(let i=0; i<count; i++) {
                const rock = new THREE.Mesh(rockGeo, rockMat);
                const x = (Math.random() - 0.5) * width; const y = (Math.random() - 0.5) * height; const z = (Math.random() * depth * 0.5); 
                rock.position.set(x, y, z);
                const s = 1.5 + Math.random() * 2.5; rock.scale.set(s, s, s); rock.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, Math.random()*Math.PI);
                group.add(rock);
            }
            return group;
        }
        function createHangingBeamLight(x, y, z) {
            const group = new THREE.Group(); group.position.set(x, y, z);
            const beamGeo = new THREE.BoxGeometry(12, 0.5, 0.5); const beamMat = new THREE.MeshStandardMaterial({ color: 0x3e2723, roughness: 0.9 }); const beam = new THREE.Mesh(beamGeo, beamMat); group.add(beam);
            const cableGeo = new THREE.CylinderGeometry(0.02, 0.02, 4); const cableMat = new THREE.MeshBasicMaterial({ color: 0x111111 });
            const cable1 = new THREE.Mesh(cableGeo, cableMat); cable1.position.set(-5, 2, 0); group.add(cable1); const cable2 = new THREE.Mesh(cableGeo, cableMat); cable2.position.set(5, 2, 0); group.add(cable2);
            for(let i=-4; i<=4; i+=2) {
                const dropLength = 0.5 + Math.random() * 1.5; 
                const wireGeo = new THREE.CylinderGeometry(0.01, 0.01, dropLength); const wire = new THREE.Mesh(wireGeo, cableMat); wire.position.set(i, -dropLength/2, 0); group.add(wire);
                const bulbGeo = new THREE.SphereGeometry(0.2, 16, 16); const bulbMat = new THREE.MeshStandardMaterial({ color: 0xffaa00, emissive: 0xffaa00, emissiveIntensity: 2 });
                const bulb = new THREE.Mesh(bulbGeo, bulbMat); bulb.position.set(i, -dropLength, 0); group.add(bulb);
                const pointLight = new THREE.PointLight(0xffaa00, 1.5, 20); pointLight.position.set(i, -dropLength, 0); pointLight.castShadow = true; pointLight.shadow.bias = -0.0001; group.add(pointLight);
            }
            scene.add(group); roomObjects.push(group);
        }
        function createIndustrialSconce(x, y, z, rotationY) {
            const group = new THREE.Group(); group.position.set(x, y, z); group.rotation.y = rotationY;
            const baseGeo = new THREE.BoxGeometry(0.5, 0.5, 0.1); const darkMetal = new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 0.8, roughness: 0.4 }); const base = new THREE.Mesh(baseGeo, darkMetal); group.add(base);
            const armGeo = new THREE.CylinderGeometry(0.05, 0.05, 0.5); armGeo.rotateX(Math.PI/2); const arm = new THREE.Mesh(armGeo, darkMetal); arm.position.z = 0.25; group.add(arm);
            const shadeGeo = new THREE.ConeGeometry(0.4, 0.5, 32, 1, true); const shade = new THREE.Mesh(shadeGeo, darkMetal); shade.position.z = 0.5; shade.rotation.x = Math.PI/2; group.add(shade);
            const bulbGeo = new THREE.SphereGeometry(0.15, 16, 16); const bulbMat = new THREE.MeshStandardMaterial({ color: 0xffaa00, emissive: 0xffaa00, emissiveIntensity: 2 }); const bulb = new THREE.Mesh(bulbGeo, bulbMat); bulb.position.z = 0.5; group.add(bulb);
            const light = new THREE.PointLight(0xffaa00, 1.2, 15); light.position.z = 0.6; light.castShadow = true; group.add(light);
            scene.add(group); roomObjects.push(group);
        }
        function createFishSchool(count) {
            const fishGeo = new THREE.ConeGeometry(0.2, 0.6, 4); fishGeo.rotateX(Math.PI / 2); const fishMat = new THREE.MeshBasicMaterial({ color: 0xf97316 });
            for(let i=0; i<count; i++) {
                const fish = new THREE.Mesh(fishGeo, fishMat); fish.position.set((Math.random() - 0.5) * 20, 0.5 + Math.random() * 1.5, (Math.random() - 0.5) * 20);
                fish.userData = { type: 'fish', velocity: new THREE.Vector3((Math.random() - 0.5) * 0.05, 0, (Math.random() - 0.5) * 0.05), animating: false };
                fish.rotation.y = Math.random() * Math.PI * 2; scene.add(fish); roomObjects.push(fish); activeFishes.push(fish); objectsToIntersect.push(fish);
            }
        }
        function updateFishes() { activeFishes.forEach(fish => { if(fish.userData.animating) return; fish.position.add(fish.userData.velocity); fish.rotation.y = Math.atan2(fish.userData.velocity.x, fish.userData.velocity.z) + Math.PI/2; if(Math.abs(fish.position.x) > 12 || Math.abs(fish.position.z) > 12) fish.userData.velocity.negate(); }); }
        function jumpFish(fish) { if(fish.userData.animating) return; fish.userData.animating = true; playSplashSound(); const tl = gsap.timeline({ onComplete: () => { fish.userData.animating = false; } }); tl.to(fish.position, { y: 3, duration: 0.3, ease: "power2.out" }).to(fish.rotation, { x: Math.PI * 2, duration: 0.5 }, "<").to(fish.position, { y: 1, duration: 0.4, ease: "bounce.out" }); }
        function createBambooWall(length, centerX, centerZ, rotation) { const group = new THREE.Group(); const bambooCount = Math.floor(length / 0.6); const geo = new THREE.CylinderGeometry(0.25, 0.35, 12, 7); const mat = new THREE.MeshStandardMaterial({ color: 0x5D4037, roughness: 0.9 }); for(let i=0; i<bambooCount; i++) { const bamboo = new THREE.Mesh(geo, mat); const offset = (i - bambooCount/2) * 0.6; bamboo.position.set(offset, 6, 0); bamboo.scale.y = 0.9 + Math.random() * 0.2; bamboo.rotation.z = (Math.random() - 0.5) * 0.1; group.add(bamboo); } group.position.set(centerX, 0, centerZ); group.rotation.y = rotation; return group; }
        function createArtifactPedestal(x, y, z, data) { const group = new THREE.Group(); group.position.set(x, y, z); const baseGeo = new THREE.BoxGeometry(2, 1, 2); const baseMat = new THREE.MeshStandardMaterial({ color: 0x334155 }); const base = new THREE.Mesh(baseGeo, baseMat); base.position.y = 0.5; base.receiveShadow = true; group.add(base); const artGeo = new THREE.BoxGeometry(1, 1, 1); const artMat = new THREE.MeshStandardMaterial({ color: data.color, emissive: data.color, emissiveIntensity: 0.3 }); const artifact = new THREE.Mesh(artGeo, artMat); artifact.position.y = 2; artifact.userData = { type: 'artifact', data: data, name: data.title }; objectsToIntersect.push(artifact); gsap.to(artifact.position, { y: 2.2, duration: 2 + Math.random(), repeat: -1, yoyo: true, ease: "sine.inOut" }); gsap.to(artifact.rotation, { y: Math.PI * 2, duration: 8, repeat: -1, ease: "none" }); addBreathingAnimation(artifact); group.add(artifact); scene.add(group); }
        function createNavigationPoint(x, y, z, direction, targetIndex) { const navGeo = new THREE.CylinderGeometry(2, 2, 0.1, 32); const navMat = new THREE.MeshBasicMaterial({ color: 0x10b981, transparent: true, opacity: 0.5 }); const nav = new THREE.Mesh(navGeo, navMat); nav.position.set(x, 0.1, z); nav.userData = { type: 'nav', direction: direction, targetIndex: targetIndex, name: direction === 'next' ? 'NEXT SECTOR' : 'PREVIOUS SECTOR' }; const arrowGeo = new THREE.ConeGeometry(0.5, 1, 4); const arrowMat = new THREE.MeshBasicMaterial({ color: 0x10b981 }); const arrow = new THREE.Mesh(arrowGeo, arrowMat); arrow.position.set(x, 1.5, z); arrow.rotation.x = Math.PI; gsap.to(arrow.position, { y: 1.2, duration: 0.8, repeat: -1, yoyo: true }); gsap.to(nav.scale, { x: 1.2, z: 1.2, duration: 1, yoyo: true, repeat: -1 }); objectsToIntersect.push(nav); scene.add(nav); scene.add(arrow); }
        function clearScene() { objectsToIntersect = []; activeFishes = []; for(let i = scene.children.length - 1; i >= 0; i--) { const obj = scene.children[i]; if(obj.type === 'Mesh' || obj.type === 'Group' || obj.type === 'GridHelper' || obj.type === 'SpotLight') scene.remove(obj); } }
        function addFloatingAnimation(group, delay) { gsap.to(group.position, { y: 0.5, duration: 2, repeat: -1, yoyo: true, delay: delay, ease: "sine.inOut" }); gsap.to(group.rotation, { y: 0.1, duration: 4, repeat: -1, yoyo: true, delay: delay, ease: "sine.inOut" }); }
        function onMouseMove(event) { mouse.x = (event.clientX / window.innerWidth) * 2 - 1; mouse.y = -(event.clientY / window.innerHeight) * 2 + 1; raycaster.setFromCamera(mouse, camera); const intersects = raycaster.intersectObjects(objectsToIntersect, true); const tooltip = document.getElementById('tooltip'); let found = false; if (intersects.length > 0) { let target = intersects[0].object; while(!target.userData.name && !target.userData.type && target.parent) target = target.parent; if (target.userData.name) { found = true; document.body.style.cursor = 'pointer'; tooltip.style.display = 'block'; tooltip.style.left = (event.clientX + 15) + 'px'; tooltip.style.top = (event.clientY + 15) + 'px'; tooltip.innerHTML = target.userData.type === 'category' ? `<strong>${target.userData.name}</strong><br><span style="color:#94a3b8; font-size:10px">${target.userData.desc}</span>` : target.userData.name; } else if (target.userData.type === 'fish') document.body.style.cursor = 'crosshair'; } if (!found) { document.body.style.cursor = 'default'; tooltip.style.display = 'none'; } }
        function onMouseClick(event) { if(state.scene === 'TITLE') return; raycaster.setFromCamera(mouse, camera); const intersects = raycaster.intersectObjects(objectsToIntersect, true); if (intersects.length > 0) { let target = intersects[0].object; if(target.userData.type === 'fish') { jumpFish(target); return; } while(!target.userData.type && target.parent) target = target.parent; playClickSound(); if (target.userData.type === 'category') enterRoom(target.userData.value, 0); else if (target.userData.type === 'artifact') showArtifactDetails(target.userData.data); else if (target.userData.type === 'nav') enterRoom(state.currentCategory, target.userData.targetIndex); } }
        function enterRoom(category, index) { 
            if(state.currentCategory !== category) { 
                state.currentCategory = category; 
                state.filteredData = filterDataByCategory(category);
                const display = document.getElementById('data-display');
                if(display) display.innerText = `● Viewing ${state.filteredData.length} items from ${category.toUpperCase().replace('_', ' ')}`;
            } 
            createRoomScene(category, index); 
        }
        function startGame() { 
            const btn = document.getElementById('start-btn');
            if(btn && btn.innerText !== "ENTER SYSTEM") return; // Prevent start if not loaded
            playClickSound(); 
            const titleScreen = document.getElementById('title-screen');
            if(titleScreen) {
                titleScreen.style.opacity = '0'; 
                setTimeout(() => { titleScreen.style.display = 'none'; createMapScene(); }, 1000); 
            }
        }
        function goBackToMap() { playClickSound(); const nav = document.getElementById('nav-controls'); if(nav) nav.style.opacity = '0'; createMapScene(); }
        function showArtifactDetails(data) { 
            const modal = document.getElementById('artifact-modal'); 
            const content = document.getElementById('modal-content'); 
            const titleEl = document.getElementById('modal-title');
            const descEl = document.getElementById('modal-desc');
            const catEl = document.getElementById('modal-category');
            const idEl = document.getElementById('modal-id');
            const dateEl = document.getElementById('modal-date');
            
            if(titleEl) titleEl.innerText = data.title; 
            if(descEl) descEl.innerText = data.description; 
            if(catEl) catEl.innerText = data.category.toUpperCase().replace('_', ' '); 
            if(idEl) idEl.innerText = data.id.toString().padStart(3, '0'); 
            if(dateEl) dateEl.innerText = `Year ${data.year}`; 
            
            const imgEl = document.getElementById('modal-img'); 
            const fallbackEl = document.getElementById('modal-img-fallback'); 
            const fallbackTitle = document.getElementById('fallback-title');
            const fallbackId = document.getElementById('fallback-id');
            const metaEl = document.getElementById('modal-meta');

            // NEW FALLBACK LOGIC
            if(imgEl) {
                imgEl.style.display = 'none'; 
                if(fallbackEl) fallbackEl.style.display = 'flex';
                
                // Update fallback text
                if(fallbackTitle) fallbackTitle.innerText = data.title;
                if(fallbackId) fallbackId.innerText = data.id;

                if(data.imageUrl) { 
                    imgEl.src = data.imageUrl; 
                    imgEl.onload = () => { imgEl.style.display = 'block'; if(fallbackEl) fallbackEl.style.display = 'none'; }; 
                    imgEl.onerror = () => { imgEl.style.display = 'none'; if(fallbackEl) fallbackEl.style.display = 'flex'; }; // ERROR HANDLER
                } 
                if(imgEl.parentElement) imgEl.parentElement.style.backgroundColor = '#' + data.color.toString(16); 
            }

            if(metaEl) {
                metaEl.innerText = state.isOffline ? 
                    "METADATA SOURCE: OFFLINE SIMULATION (DEMO)" : 
                    "METADATA SOURCE: GOOGLE SHEETS LIVE";
                metaEl.className = state.isOffline ? 
                    "mt-4 text-xs text-orange-500 font-mono border-t border-gray-800 pt-2" :
                    "mt-4 text-xs text-green-500 font-mono border-t border-gray-800 pt-2";
            }
            
            if(modal) {
                modal.classList.remove('hidden'); 
                setTimeout(() => { modal.classList.remove('opacity-0'); if(content) {content.classList.remove('scale-95'); content.classList.add('scale-100');} }, 10); 
            }
        }
        function closeModal() { playClickSound(); const modal = document.getElementById('artifact-modal'); if(modal) { modal.classList.add('opacity-0'); setTimeout(() => { modal.classList.add('hidden'); }, 300); } }
        function openInfoModal() { playClickSound(); const modal = document.getElementById('info-modal'); if(modal) { modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); }, 10); } }
        function closeInfoModal() { playClickSound(); const modal = document.getElementById('info-modal'); if(modal) { modal.classList.add('opacity-0'); setTimeout(() => { modal.classList.add('hidden'); }, 300); } }
        function onWindowResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
        function animate() { requestAnimationFrame(animate); if(controls) controls.update(); updateFishes(); renderer.render(scene, camera); }

        init();
    </script>
</body>

</html>
